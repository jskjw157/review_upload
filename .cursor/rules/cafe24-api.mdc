---
description: Cafe24 쇼핑몰 API 연동 가이드 - OAuth 인증, Admin/Front API, Rate Limiting, 에러 처리
globs: 
  - "src/main/services/**/*.ts"
  - "src/renderer/services/**/*.ts"
  - "**/cafe24*.ts"
  - "**/auth*.ts"
  - "**/review*.ts"
  - "**/api/**/*.ts"
alwaysApply: false
---

# Cafe24 API Development Rules

## API Overview

Cafe24 provides RESTful APIs for shopping mall integration and app development.

| API Type             | Purpose                                           | Auth Required |
| -------------------- | ------------------------------------------------- | ------------- |
| **Admin API**        | Full CRUD for store data (products, orders, etc.) | OAuth 2.0     |
| **Front API**        | Public product info, cart, customer actions       | Limited       |
| **D.Collection API** | Marketing/Ad services, store analytics            | Basic Auth    |
| **Cafe24 Analytics** | Customer behavior data (Beta)                     | OAuth 2.0     |

---

## API Base URLs

```javascript
// Admin API
const ADMIN_API = 'https://{mallid}.cafe24api.com/api/v2/admin'

// Front API
const FRONT_API = 'https://{mallid}.cafe24api.com/api/v2'

// D.Collection API
const DCOLLECTION_API = 'https://dcollection.cafe24api.com/api/v1'
```

---

## Request/Response Format

-   **Format**: JSON only
-   **Protocol**: HTTPS only (privacy protection)
-   **Date Format**: ISO 8601 (`YYYY-MM-DDTHH:MM:SS+09:00`)
-   **Currency**: ISO 4217 format

### Request Headers

```javascript
const headers = {
    'Content-Type': 'application/json',
    Authorization: 'Bearer {access_token}',
    'X-Cafe24-Api-Version': '2024-03-01', // Optional: specify API version
}
```

### Response Structure

```javascript
// Success Response
{
    "resource": {
        "key": "value"
    }
}

// Error Response
{
    "error": {
        "code": "error_code",
        "message": "error message",
        "more_info": {}
    }
}
```

---

## OAuth 2.0 Authentication (Admin API)

### Step 1: Get Authorization Code

```javascript
// Redirect user to authorization URL
const authUrl =
    `https://{mallid}.cafe24api.com/api/v2/oauth/authorize?` +
    `response_type=code&` +
    `client_id={client_id}&` +
    `state={state}&` +
    `redirect_uri={redirect_uri}&` +
    `scope={scopes}`
```

### Step 2: Get Access Token

```javascript
const response = await fetch('https://{mallid}.cafe24api.com/api/v2/oauth/token', {
    method: 'POST',
    headers: {
        Authorization: 'Basic ' + btoa(`${client_id}:${client_secret}`),
        'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: new URLSearchParams({
        grant_type: 'authorization_code',
        code: authCode,
        redirect_uri: redirectUri,
    }),
})

const { access_token, refresh_token, expires_at } = await response.json()
```

### Step 3: Refresh Token

```javascript
const response = await fetch('https://{mallid}.cafe24api.com/api/v2/oauth/token', {
    method: 'POST',
    headers: {
        Authorization: 'Basic ' + btoa(`${client_id}:${client_secret}`),
        'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: new URLSearchParams({
        grant_type: 'refresh_token',
        refresh_token: refreshToken,
    }),
})
```

---

## Admin API Examples

### Get Products

```javascript
// GET /api/v2/admin/products
const getProducts = async (accessToken) => {
    const response = await fetch('https://{mallid}.cafe24api.com/api/v2/admin/products?' + 'limit=100&offset=0', {
        headers: {
            Authorization: `Bearer ${accessToken}`,
            'Content-Type': 'application/json',
        },
    })
    return response.json()
}
```

### Get Orders

```javascript
// GET /api/v2/admin/orders
const getOrders = async (accessToken, startDate, endDate) => {
    const params = new URLSearchParams({
        start_date: startDate, // YYYY-MM-DD
        end_date: endDate,
        limit: '100',
    })

    const response = await fetch(`https://{mallid}.cafe24api.com/api/v2/admin/orders?${params}`, {
        headers: {
            Authorization: `Bearer ${accessToken}`,
            'Content-Type': 'application/json',
        },
    })
    return response.json()
}
```

### Update Product

```javascript
// PUT /api/v2/admin/products/{product_no}
const updateProduct = async (accessToken, productNo, data) => {
    const response = await fetch(`https://{mallid}.cafe24api.com/api/v2/admin/products/${productNo}`, {
        method: 'PUT',
        headers: {
            Authorization: `Bearer ${accessToken}`,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            shop_no: 1,
            request: data,
        }),
    })
    return response.json()
}
```

---

## Front API Examples

### Get Product List (Public)

```javascript
// GET /api/v2/products
const getPublicProducts = async (mallId) => {
    const response = await fetch(`https://${mallId}.cafe24api.com/api/v2/products?` + 'display=true&selling=true&limit=50')
    return response.json()
}
```

### Add to Cart

```javascript
// POST /api/v2/cart
const addToCart = async (mallId, productNo, quantity, options) => {
    const response = await fetch(`https://${mallId}.cafe24api.com/api/v2/cart`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            product_no: productNo,
            quantity: quantity,
            options: options,
        }),
    })
    return response.json()
}
```

---

## D.Collection API (Partner Only)

### Authentication

```javascript
// Basic Auth for D.Collection
const headers = {
    Authorization: 'Basic ' + btoa(`${partner_id}:${secret_key}`),
    'Content-Type': 'application/json',
}
```

### Get Store Data

```javascript
const getStoreData = async (storeId) => {
    const response = await fetch(`https://dcollection.cafe24api.com/api/v1/stores/${storeId}`, { headers })
    return response.json()
}
```

---

## API Rate Limits

| API Type     | Limit              |
| ------------ | ------------------ |
| Admin API    | 5 requests/second  |
| Front API    | 10 requests/second |
| D.Collection | 3 requests/second  |

### Rate Limit Headers

```javascript
// Check rate limit in response headers
const remaining = response.headers.get('X-Api-Call-Limit')
// Format: "current/max" e.g., "3/5"
```

---

## API Versioning

-   Version format: `YYYY-MM-DD`
-   Set via header: `X-Cafe24-Api-Version`
-   Versions valid for 1 year from latest release
-   Default: App setup version or latest if expired

```javascript
// Specify API version
headers['X-Cafe24-Api-Version'] = '2024-03-01'
```

---

## Admin API Full Endpoints

All endpoints are prefixed with `/api/v2/admin`

### Products

```
GET    /products                           # List all products
GET    /products/{product_no}              # Get product details
POST   /products                           # Create new product
PUT    /products/{product_no}              # Update product
DELETE /products/{product_no}              # Delete product
GET    /products/{product_no}/variants     # Get product variants
POST   /products/{product_no}/variants     # Create variant
PUT    /products/{product_no}/variants/{variant_code}  # Update variant
DELETE /products/{product_no}/variants/{variant_code}  # Delete variant
GET    /products/{product_no}/options      # Get product options
POST   /products/{product_no}/options      # Create option
GET    /products/{product_no}/images       # Get product images
POST   /products/{product_no}/images       # Upload image
DELETE /products/{product_no}/images/{image_no}  # Delete image
GET    /products/{product_no}/hits         # Get product view count
GET    /products/{product_no}/decorationimages  # Get decoration images
```

### Categories

```
GET    /categories                         # List all categories
GET    /categories/{category_no}           # Get category details
POST   /categories                         # Create category
PUT    /categories/{category_no}           # Update category
DELETE /categories/{category_no}           # Delete category
GET    /categories/{category_no}/products  # Get products in category
POST   /categories/{category_no}/products  # Add product to category
DELETE /categories/{category_no}/products/{product_no}  # Remove from category
```

### Orders

```
GET    /orders                             # List all orders
GET    /orders/{order_id}                  # Get order details
PUT    /orders/{order_id}                  # Update order
GET    /orders/{order_id}/items            # Get order items
PUT    /orders/{order_id}/items/{order_item_code}  # Update order item
GET    /orders/{order_id}/receivers        # Get shipping addresses
PUT    /orders/{order_id}/receivers/{order_item_code}  # Update address
GET    /orders/{order_id}/return           # Get return info
POST   /orders/{order_id}/return           # Request return
GET    /orders/{order_id}/exchange         # Get exchange info
POST   /orders/{order_id}/exchange         # Request exchange
GET    /orders/{order_id}/cancellation     # Get cancellation info
POST   /orders/{order_id}/cancellation     # Request cancellation
```

### Customers (Members)

```
GET    /customers                          # List all customers
GET    /customers/{member_id}              # Get customer details
POST   /customers                          # Create customer
PUT    /customers/{member_id}              # Update customer
DELETE /customers/{member_id}              # Delete customer
GET    /customers/{member_id}/mileage      # Get mileage history
POST   /customers/{member_id}/mileage      # Add/deduct mileage
GET    /customers/{member_id}/points       # Get points
GET    /customers/{member_id}/coupons      # Get customer coupons
POST   /customers/{member_id}/coupons      # Issue coupon to customer
GET    /customers/{member_id}/orders       # Get customer orders
GET    /customers/{member_id}/wishlist     # Get wishlist
```

### Inventory (Stock)

```
GET    /products/{product_no}/inventory    # Get stock info
PUT    /products/{product_no}/inventory    # Update stock
GET    /inventory                          # List all inventory
PUT    /inventory                          # Bulk update inventory
GET    /inventoryhistory                   # Get inventory history
```

### Shipments

```
GET    /orders/{order_id}/shipments        # Get shipment info
POST   /orders/{order_id}/shipments        # Create shipment
PUT    /orders/{order_id}/shipments        # Update shipment
GET    /shipments                          # List all shipments
GET    /shippingcarriers                   # List shipping carriers
```

### Coupons

```
GET    /coupons                            # List all coupons
GET    /coupons/{coupon_no}                # Get coupon details
POST   /coupons                            # Create coupon
PUT    /coupons/{coupon_no}                # Update coupon
DELETE /coupons/{coupon_no}                # Delete coupon
GET    /coupons/{coupon_no}/issues         # Get issued coupons
POST   /coupons/{coupon_no}/issues         # Issue coupon
```

### Promotions

```
GET    /promotions                         # List promotions
GET    /promotions/{promotion_no}          # Get promotion details
POST   /promotions                         # Create promotion
PUT    /promotions/{promotion_no}          # Update promotion
DELETE /promotions/{promotion_no}          # Delete promotion
```

### Store Settings

```
GET    /store                              # Get store info
PUT    /store                              # Update store info
GET    /shops                              # List multi-shops
GET    /shops/{shop_no}                    # Get shop details
GET    /paymentmethods                     # List payment methods
GET    /shippingpolicies                   # List shipping policies
PUT    /shippingpolicies/{policy_no}       # Update shipping policy
```

### Boards (Posts)

```
GET    /boards                             # List all boards
GET    /boards/{board_no}                  # Get board details
GET    /boards/{board_no}/articles         # List articles
GET    /boards/{board_no}/articles/{article_no}  # Get article
POST   /boards/{board_no}/articles         # Create article
PUT    /boards/{board_no}/articles/{article_no}  # Update article
DELETE /boards/{board_no}/articles/{article_no}  # Delete article
GET    /boards/{board_no}/articles/{article_no}/comments  # Get comments
POST   /boards/{board_no}/articles/{article_no}/comments  # Create comment
```

### Reviews

```
GET    /products/{product_no}/reviews      # Get product reviews
GET    /reviews                            # List all reviews
GET    /reviews/{review_no}                # Get review details
PUT    /reviews/{review_no}                # Update review (reply)
DELETE /reviews/{review_no}                # Delete review
```

### Brands

```
GET    /brands                             # List all brands
GET    /brands/{brand_code}                # Get brand details
POST   /brands                             # Create brand
PUT    /brands/{brand_code}                # Update brand
DELETE /brands/{brand_code}                # Delete brand
```

### Suppliers (Vendors)

```
GET    /suppliers                          # List suppliers
GET    /suppliers/{supplier_code}          # Get supplier details
POST   /suppliers                          # Create supplier
PUT    /suppliers/{supplier_code}          # Update supplier
DELETE /suppliers/{supplier_code}          # Delete supplier
```

### Mileage

```
GET    /mileagesetting                     # Get mileage settings
PUT    /mileagesetting                     # Update mileage settings
GET    /mileage                            # List mileage history
POST   /mileage                            # Add mileage
```

### Reports & Analytics

```
GET    /reports/salesperformance           # Sales performance
GET    /reports/ordersummary               # Order summary
GET    /reports/productsales               # Product sales report
GET    /reports/customersummary            # Customer summary
```

---

## Error Codes

| Code | Description           |
| ---- | --------------------- |
| 400  | Bad Request           |
| 401  | Unauthorized          |
| 403  | Forbidden             |
| 404  | Not Found             |
| 422  | Unprocessable Entity  |
| 429  | Too Many Requests     |
| 500  | Internal Server Error |

---

## Best Practices

1. **Always check rate limits** before bulk operations
2. **Cache access tokens** and refresh before expiry
3. **Use pagination** for large datasets (`limit`, `offset`)
4. **Handle errors gracefully** with retry logic for 429/500
5. **Validate data** before API calls to reduce errors
6. **Use webhooks** for real-time updates when available

---

## Official Documentation

-   Admin API: https://developers.cafe24.com/docs/en/api/admin
-   Front API: https://developers.cafe24.com/docs/en/api/front
-   D.Collection: https://developers.cafe24.com/docs/en/api/dcollection
-   Analytics API: https://developers.cafe24.com/docs/en/api/analytics

---

## Front API Full Endpoints

All endpoints are prefixed with `/api/v2`

### Products

```
GET /products                             # List all products
GET /products/{product_no}                # Get product details
GET /products/{product_no}/variants       # Get product variants/options
GET /products/{product_no}/hits           # Get product view count
GET /products/search                      # Search products
```

### Categories

```
GET /categories                           # List all categories
GET /categories/{category_no}             # Get category details
GET /categories/{category_no}/products    # Get products in category
```

### Cart

```
GET    /cart                              # Get cart contents
POST   /cart                              # Add item to cart
PUT    /cart/{cart_no}                    # Update cart item
DELETE /cart/{cart_no}                    # Remove cart item
DELETE /cart                              # Clear entire cart
```

### Orders

```
GET /orders                               # List orders (login required)
GET /orders/{order_id}                    # Get order details (login required)
GET /orders/guest/{order_id}              # Get guest order details
```

### Members

```
GET    /members/me                        # Get my profile
PUT    /members/me                        # Update my profile
GET    /members/me/coupons                # Get my coupons
GET    /members/me/mileage                # Get my mileage
GET    /members/me/wishlist               # Get my wishlist
POST   /members/me/wishlist               # Add to wishlist
DELETE /members/me/wishlist/{product_no}  # Remove from wishlist
```

### Boards

```
GET  /boards                              # List all boards
GET  /boards/{board_no}/articles          # List articles
GET  /boards/{board_no}/articles/{article_no}  # Get article details
POST /boards/{board_no}/articles          # Create article
```

### Reviews

```
GET  /products/{product_no}/reviews       # List product reviews
POST /products/{product_no}/reviews       # Create review
```

### Search

```
GET /search/products                      # Search products
GET /search/autocomplete                  # Get autocomplete suggestions
```

---

## Webhook Events

### Available Events

| Event             | Trigger                  |
| ----------------- | ------------------------ |
| `order.created`   | When order is created    |
| `order.paid`      | When payment completed   |
| `order.shipped`   | When shipment starts     |
| `order.delivered` | When delivery completed  |
| `order.cancelled` | When order is cancelled  |
| `order.refunded`  | When refund completed    |
| `product.created` | When product is created  |
| `product.updated` | When product is updated  |
| `product.deleted` | When product is deleted  |
| `stock.updated`   | When stock changes       |
| `member.created`  | When member signs up     |
| `member.updated`  | When member info updated |
| `review.created`  | When review is posted    |

### Webhook Payload Example

```javascript
// Webhook request body
{
    "event_no": 12345,
    "event_type": "order.created",
    "resource": {
        "shop_no": 1,
        "order_id": "20240101-0000001",
        "order_date": "2024-01-01T12:00:00+09:00",
        "buyer_name": "John Doe",
        "order_amount": 50000
    },
    "timestamp": "2024-01-01T12:00:05+09:00"
}
```

### Webhook Handler Example

```javascript
// Express.js webhook handler
app.post('/webhook/cafe24', (req, res) => {
    const { event_type, resource } = req.body

    switch (event_type) {
        case 'order.created':
            handleNewOrder(resource)
            break
        case 'order.paid':
            handlePaymentComplete(resource)
            break
        case 'stock.updated':
            handleStockChange(resource)
            break
    }

    res.status(200).json({ received: true })
})
```

---

## Error Handling Helper

```javascript
// API 에러 핸들링 유틸리티
class Cafe24ApiError extends Error {
    constructor(code, message, moreInfo = {}) {
        super(message)
        this.code = code
        this.moreInfo = moreInfo
    }
}

const handleApiResponse = async (response) => {
    const data = await response.json()

    if (!response.ok) {
        const { error } = data
        throw new Cafe24ApiError(error.code, error.message, error.more_info)
    }

    return data
}

// Rate limit 체크 및 재시도 로직
const fetchWithRetry = async (url, options, maxRetries = 3) => {
    for (let i = 0; i < maxRetries; i++) {
        const response = await fetch(url, options)

        // Rate limit 체크
        const rateLimit = response.headers.get('X-Api-Call-Limit')
        if (rateLimit) {
            const [current, max] = rateLimit.split('/')
            if (parseInt(current) >= parseInt(max) - 1) {
                await new Promise((r) => setTimeout(r, 1000)) // 1초 대기
            }
        }

        // 429 Too Many Requests
        if (response.status === 429) {
            await new Promise((r) => setTimeout(r, 2000 * (i + 1)))
            continue
        }

        // 500 에러 재시도
        if (response.status >= 500 && i < maxRetries - 1) {
            await new Promise((r) => setTimeout(r, 1000 * (i + 1)))
            continue
        }

        return handleApiResponse(response)
    }

    throw new Error('Max retries exceeded')
}
```

---

## Mall ID Usage Example

```javascript
// Mall ID is the subdomain of your store
// Example: https://myshop.cafe24.com → mallId = 'myshop'

const MALL_ID = 'myshop' // Replace with your actual mall ID

// Create API client
const createCafe24Client = (mallId, accessToken) => {
    const baseUrl = `https://${mallId}.cafe24api.com/api/v2`

    const request = async (endpoint, options = {}) => {
        const url = `${baseUrl}${endpoint}`
        const headers = {
            'Content-Type': 'application/json',
            ...(accessToken && { Authorization: `Bearer ${accessToken}` }),
            ...options.headers,
        }

        return fetchWithRetry(url, { ...options, headers })
    }

    return {
        // Products
        getProducts: (params) => request(`/products?${new URLSearchParams(params)}`),
        getProduct: (productNo) => request(`/products/${productNo}`),

        // Cart
        getCart: () => request('/cart'),
        addToCart: (data) => request('/cart', { method: 'POST', body: JSON.stringify(data) }),

        // Members
        getMe: () => request('/members/me'),
        getMyWishlist: () => request('/members/me/wishlist'),

        // Orders
        getOrders: (params) => request(`/orders?${new URLSearchParams(params)}`),
    }
}

// Usage example
const cafe24 = createCafe24Client('myshop', 'your_access_token')
const products = await cafe24.getProducts({ limit: 20, display: true })
```

---

## Response Language

-   Always respond in Korean
